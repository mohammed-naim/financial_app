{% extends "base.html" %}
{% block content %}
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="text-success fw-bold" style="font-family: 'Poppins', sans-serif;">
                    <i class="bi bi-tags-fill"></i> Categories
                </h1>
                <p class="text-muted">Manage your income and expense categories here.</p>
            </div>
        </div>

        <!-- CONTROLS CARD -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body d-flex flex-wrap align-items-center justify-content-between">
                <!-- Filter by Type -->
                <div class="d-flex align-items-center mb-3 mb-md-0">
                    <label for="filterType" class="form-label fw-semibold me-2 mb-0">Filter by Type:</label>
                    <select id="filterType" class="form-select w-auto" onchange="loadCategories()">
                        <option value="">All</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>

                <!-- Sort Options -->
                <div class="d-flex align-items-center mb-3 mb-md-0">
                    <label for="sortOptions" class="form-label fw-semibold me-2 mb-0">Sort by:</label>
                    <select id="sortOptions" class="form-select w-auto" onchange="loadCategories()">
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="type">Type</option>
                    </select>
                </div>

                <!-- Add Category Button -->
                <button class="btn btn-outline-success" onclick="showModal('addCategoryModal')">
                    <i class="bi bi-plus-circle"></i> Add Category
                </button>
            </div>
        </div>

        <!-- CATEGORIES TABLE CARD -->
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-card-list"></i> All Categories</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped align-middle mb-0">
                        <thead class="table-success">
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="categoryTableBody">
                        <!-- Categories will be rendered here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD CATEGORY MODAL -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="addCategoryForm" onsubmit="addCategory(event)">
                    <div class="modal-header">
                        <h5 class="modal-title text-success fw-bold">Add Category</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name</label>
                            <input
                                    type="text"
                                    class="form-control"
                                    id="categoryName"
                                    placeholder="e.g., Food & Dining"
                                    required
                            >
                        </div>
                        <div class="mb-3">
                            <label for="categoryType" class="form-label">Type</label>
                            <select class="form-select" id="categoryType" required>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Add
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- EDIT CATEGORY MODAL -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="editCategoryForm" onsubmit="editCategory(event)">
                    <div class="modal-header">
                        <h5 class="modal-title text-success fw-bold">Edit Category</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editCategoryName" class="form-label">Category Name</label>
                            <input
                                    type="text"
                                    class="form-control"
                                    id="editCategoryName"
                                    required
                            >
                        </div>
                        <!-- Uncomment if you want to allow editing category type
                        <div class="mb-3">
                            <label for="editCategoryType" class="form-label">Type</label>
                            <select class="form-select" id="editCategoryType" required>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                        -->
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', loadCategories);

        // Load categories from the server
        function loadCategories() {
            const filterType = document.getElementById('filterType').value;
            const sortOption = document.getElementById('sortOptions').value;

            fetch(`/api/category/`)
                .then(response => response.json())
                .then(data => {
                    let categories = data.categories;

                    // Filter by type
                    if (filterType) {
                        categories = categories.filter(category => category.type === filterType);
                    }

                    // Sort categories
                    if (sortOption === 'name_asc') {
                        categories.sort((a, b) => a.name.localeCompare(b.name));
                    } else if (sortOption === 'name_desc') {
                        categories.sort((a, b) => b.name.localeCompare(a.name));
                    } else if (sortOption === 'type') {
                        categories.sort((a, b) => a.type.localeCompare(b.type));
                    }

                    renderCategoryTable(categories);
                })
                .catch(err => {
                    console.error('Error loading categories:', err);
                    showToast('Error loading categories.', 'danger');
                });
        }

        // Render categories in table
        function renderCategoryTable(categories) {
            const tableBody = document.getElementById('categoryTableBody');
            tableBody.innerHTML = '';

            categories.forEach(category => {
                const row = document.createElement('tr');

                let rowHTML = `
            <td>${category.name}</td>
            <td>
                <span class="badge bg-${category.type === 'income' ? 'success' : 'warning'}">
                    ${category.type.charAt(0).toUpperCase() + category.type.slice(1)}
                </span>
            </td>
            <td>
                ${
                    category.disabled
                        ? '<span class="text-danger fw-bold">Disabled</span>'
                        : '<span class="text-success fw-bold">Enabled</span>'
                }
            </td>
            <td class="text-center">
                <button
                    class="btn btn-sm btn-warning me-1"
                    onclick="openEditCategoryModal(${category.id}, '${category.name}')"
                >
                    <i class="bi bi-pencil-square"></i> Edit
                </button>
        `;

                // If disabled, show "Enable" button. Otherwise, show "Disable" + "Delete"
                if (category.disabled) {
                    rowHTML += `
                <button
                    class="btn btn-sm btn-primary"
                    onclick="enableCategory(${category.id})"
                >
                    <i class="bi bi-plus-circle"></i> Enable
                </button>
            `;
                } else {
                    rowHTML += `
                <button
                    class="btn btn-sm btn-secondary me-1"
                    onclick="confirmDisableCategory(${category.id})"
                >
                    <i class="bi bi-dash-circle"></i> Disable
                </button>
            `;
                }
                rowHTML += `
                <button
                    class="btn btn-sm btn-danger"
                    onclick="confirmDeleteCategory(${category.id})"
                >
                    <i class="bi bi-trash-fill"></i> Delete
                </button>
            `;

                rowHTML += `</td>`;
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });
        }


        function confirmDisableCategory(id) {
            showCustomConfirm('Disable Category', 'Are you sure you want to disable this category?')
                .then(userConfirmed => {
                    if (userConfirmed) {
                        fetch(`/api/category/disable/${id}`, {method: 'PUT'})
                            .then(response => response.json())
                            .then(data => {
                                if (data.message) {
                                    showToast(data.message, 'success');
                                    loadCategories();
                                } else {
                                    showToast(data.error || 'Error disabling category', 'danger');
                                }
                            })
                            .catch(err => {
                                console.error('Error disabling category:', err);
                                showToast('An error occurred while disabling the category.', 'danger');
                            });
                    }
                });
        }

        // Add category
        function addCategory(event) {
            event.preventDefault();
            fetch('/api/category/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: document.getElementById('categoryName').value,
                    category_type: document.getElementById('categoryType').value
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'Category created successfully') {
                        showToast('Category added successfully!', 'success');
                        document.getElementById('addCategoryForm').reset();
                        bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                        loadCategories();
                    } else {
                        showToast(data.error || 'Error adding category', 'danger');
                    }
                })
                .catch(err => {
                    console.error('Error adding category:', err);
                    showToast('An error occurred while adding the category.', 'danger');
                });
        }

        // Open edit modal, fill in data
        function openEditCategoryModal(id, name) {
            document.getElementById('editCategoryName').value = name;
            document.getElementById('editCategoryForm').setAttribute('data-id', id);
            showModal('editCategoryModal');
        }

        // Edit category
        function editCategory(event) {
            event.preventDefault();
            const categoryId = document.getElementById('editCategoryForm').getAttribute('data-id');
            fetch(`/api/category/${categoryId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: document.getElementById('editCategoryName').value,
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'Category updated successfully') {
                        showToast('Category updated successfully!', 'success');
                        document.getElementById('editCategoryForm').reset();
                        bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
                        loadCategories();
                    } else {
                        showToast(data.error || 'Error updating category', 'danger');
                    }
                })
                .catch(err => {
                    console.error('Error updating category:', err);
                    showToast('An error occurred while updating the category.', 'danger');
                });
        }

        // Confirm delete, then call actual delete
        function confirmDeleteCategory(id) {
            // Use our custom confirm from base.html:
            showCustomConfirm('Delete Category', 'Are you sure you want to delete this category?')
                .then(userConfirmed => {
                    if (userConfirmed) {
                        deleteCategory(id);
                    }
                });
        }

        // Delete category
        function deleteCategory(id) {
            fetch(`/api/category/${id}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'Category deleted successfully') {
                        showToast('Category deleted successfully!', 'success');
                        loadCategories();
                    } else {
                        showToast(data.error || 'Error deleting category', 'danger');
                    }
                })
                .catch(err => {
                    console.error('Error deleting category:', err);
                    showToast('An error occurred while deleting the category.', 'danger');
                });
        }

        // Confirm enable, then call actual enable
        function enableCategory(id) {
            showCustomConfirm('Enable Category', 'Are you sure you want to enable this category?')
                .then(userConfirmed => {
                    if (userConfirmed) {
                        fetch(`/api/category/enable/${id}`, {method: 'PUT'})
                            .then(response => response.json())
                            .then(data => {
                                if (data.message) {
                                    showToast(data.message, 'success');
                                    loadCategories();
                                } else {
                                    showToast(data.error || 'Error enabling category', 'danger');
                                }
                            })
                            .catch(err => {
                                console.error('Error enabling category:', err);
                                showToast('An error occurred while enabling the category.', 'danger');
                            });
                    }
                });
        }
    </script>
{% endblock %}
